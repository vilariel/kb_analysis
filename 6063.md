Ticket 6063 - Mejoras en las listas de precios

Se requiere analizar la factibilidad y complejidad de las siguientes mejoras relacionadas con las reglas de precios y el c√°lculo de precios.

1) Que las reglas de precios tengan varias acciones asociadas, no solo una. Por ejemplo, una regla podr√≠a aplicar un descuento del 10% y adem√°s agregar un cargo fijo de $50. Actualmente solo se puede hacer una cosa u otra, pero no ambas a la vez.

Desde el punto de vista t√©cnico, la acci√≥n de cada regla est√° definida por los atributos 'type' y 'value'. Cada regla tiene un solo par type/value (por ejemplo type='addvalue' y value='50', que significa "agregar valor fijo de $50"). Quiero modificar esto para que cada regla pueda tener m√∫ltiples pares type/value asociados, y se apliquen todos cuando la condici√≥n se cumple. Se me ocurre que se deber√≠a crear un nuevo atributo 'actions' que sea un array de objetos, cada uno con su propio type y value y crear una migraci√≥n para convertir las reglas existentes a este nuevo formato.

2) Que haya reglas para modificar datos/valores del viaje. Actualmente las funciones de c√°lculo de precios utilizan la lista de precios y sus reglas para determinar el precio que se est√© calculando (hay dos funciones para calcular el precio de la distancia (una si es por kil√≥metros y la otra si es por tiempo de disposici√≥n del auto) y una tercera para calcular el precio de espera). Estas funciones, adem√°s del precio calculado devuelven otros datos. Entre ellos, devuelven variables "activadas" por las reglas de precios. Al momento hay 2 variables que est√°n preconfiguradas y tienen impacto en el viaje:
- USE_VAT2: Si la lista de precios activa esta variable, se activa el tilde (oculto) FIX_USE_VAT2 del viaje, que hace que, en caso de que se aplique IVA, el mismo sea al 21% en lugar del 10.5% (en realidad eso es configurable en los par√°metros adicionales, pero por defecto es as√≠).
- INCLUDE_BASE_DISTANCES: Si la lista de precios activa esta variable, se activa el tilde (oculto) FIX_INCLUDE_BASE_DISTANCES_CL o FIX_INCLUDE_BASE_DISTANCES_CH del viaje (dependiendo si la lista de precios se utiliz√≥ para el c√°lculo de los precios para el cliente o para el chofer). Esto hace que a las f√≥rmulas de distancia correspondiente se les agreguen los tramos de ida y vuelta a la base (0A, B0, y/o A0 seg√∫n corresponda).

Cuando sucede esto, se requiere que haya un re-c√°lculo de los precios del viaje, ya que estas variables afectan el c√°lculo. De todas maneras, deber√≠as revisar los phpdoc de las funciones ViajesCostService::calculateDistancesAndPrices() y ViajesCostService::processPriceListVariables() para entender las restricciones que tienen hoy estos mecanismos.

Lo que quiero es que una lista de precios, por medio de las acciones de sus reglas, pueda hacer lo siguiente:
- Activar y desactivar tildes (checks) del viaje (de esta manera no ser√≠a necesario crear variables espec√≠ficas como USE_VAT2, sino que se podr√≠a activar o desactivar cualquier tilde del viaje, incluendo FIX_USE_VAT2). Tambi√©n podr√≠a activar o desactivar cualquier check del viaje.
- Modificar valores num√©ricos del viaje, como los kil√≥metros o cualquier otro valor num√©rico del viaje, que pueden ser modificados por las reglas. Ejemplos:
  a) Hay una agencia que quiere que a todos los viajes que cumplen con determinada condici√≥n, se le sumen 2 kil√≥metros adicionales.
  b) Otra agencia quiere detallar el valor correspondiente al cargo por viaje nocturno. Actualmente ese valor se calcula y se suma al precio total, pero no queda registrado en ning√∫n lado. Contando con una regla que modifique valores num√©ricos del viaje y agregando un campo `night_charge` al viaje, se podr√≠a hacer que la regla modifique ese campo con el valor correspondiente, y luego el sistema podr√≠a mostrar ese valor en los listados y en la impresi√≥n del viaje.
- Seleccionar (o cambiar la selecci√≥n de) el campo Destino Frecuente. De esa manera, si las reglas de precios que detectan las zonas de origen y destino del viaje, podr√≠an adem√°s seleccionar el destino frecuente correspondiente en el viaje. Eso permitir√≠a que, bajo determinadas condiciones, dados 2 viajes que tienen las mismas zonas de origen y destino, uno tenga un destino frecuente seleccionado autom√°ticamente y el otro no.

3) Si hay reglas para modificar los datos/valores del viaje, entonces el mecanismo actual de activar/desactivar variables deber√≠a hacerse de esa manera. Actualmente, las reglas de precios tienen una condici√≥n, una acci√≥n (type/value) y una "acci√≥n complementaria", que puede ser indicar que se debe detener el procesamiento de las reglas siguientes, o activar/desactivar una variable. Lo que quiero es que esa "acci√≥n complementaria" se convierta en una acci√≥n m√°s, parecida a la de activar y desactivar tildes del viaje. De esa manera, todas las acciones de una regla estar√°n en el mismo formato (type/value) y no habr√° una acci√≥n especial para activar/desactivar variables.

4) Poder agregar tabs o pesta√±as de reglas de precios. Actualmente todas las reglas de una lista de precios est√°n en un solo listado. Quiero poder agrupar las reglas en pesta√±as, de manera que se puedan organizar mejor cuando hay muchas reglas. Cada pesta√±a tendr√≠a su propio nombre, y dentro de cada pesta√±a estar√≠an las reglas correspondientes. Las pesta√±as se podr√≠an reordenar, agregar y eliminar. El orden de ejecuci√≥n de las reglas seguir√≠a siendo el mismo (las reglas de cada pesta√±a de arriba hacia abajo, y cada pesta√±a de izquierda a derecha).

5) Relacionado con el punto anterior, que se puedan copiar pesta√±as completas de reglas de precios entre listas de precios. Desde una lista de precios, deber√≠a poder seleccionar una pesta√±a de reglas de otra lista de precios y copiarla (con todas sus reglas) a la lista de precios actual. Tambi√©n, cuando estoy editando una lista de precios deber√≠a poder copiar una pesta√±a a otras listas de precios existentes (seleccionando una o varias listas de precios destino). Si la pesta√±a ya existe en la lista de precios destino (mismo nombre), deber√≠a preguntar si se quiere reemplazar la pesta√±a o no copiarla, ya que no quiero que haya pesta√±as duplicadas en una misma lista de precios.

6) Que la funci√≥n de c√°lculo de precios para distancia (se llama calcDistancePrice() tanto en frontend como en backend), calcule 2 precios por separado: por zona y por kil√≥metro. Actualmente esa funci√≥n calcula un √∫nico precio. La forma m√°s f√°cil de hacerlo es que siga calculando el precio total como lo hace hoy. Pero adem√°s, que calcule otro precio separado que ignore aquellas reglas que tengan condiciones basadas en zonas. Ese segundo precio ser√≠a el precio "por kil√≥metro puro", sin considerar zonas. Adicionalmente, deber√≠a haber un par√°metro adicional o un tilde en cada lista de precios que permitiera configurar que "Si el precio por kil√≥metro puro es mayor que el precio total calculado, usar el precio por kil√≥metro puro".

7) El tarifario de TBD tiene indicaciones como "incluye 40' de viaje, excedente se cobra al valor de hora de espera". Si TBD define, por ejemplo, un valor fijo para los traslados desde Aeroparque a Ezeiza y que incluyen 60' de viaje, y por alg√∫n motivo (problemas de tr√°nsito, ruta cortada, etc), ese viaje dura 80 minutos, los 20 minutos excedentes se cobran al valor de espera. Para cumplir con este requerimiento, se deber√≠a agregar una nueva acci√≥n de regla de precios que permita definir "minutos incluidos" en el viaje. Esa acci√≥n ser√≠a utilizada por la funci√≥n de c√°lculo de precio de espera, para, teniendo en cuenta los minutos totales del viaje, restando los minutos incluidos definidos por la regla de precios, y sumando los minutos de espera normal (en caso de que los hubiera), para calcular el total de minutos a cobrar por espera.

8) Numerar las reglas de precios para mejorar la legibilidad de las mismas. Esta numeraci√≥n s√≥lo tiene efecto visual en la pantalla de edici√≥n de reglas de precios, y no afecta en nada la l√≥gica de ejecuci√≥n de las mismas (que sigue siendo de arriba hacia abajo seg√∫n el orden definido por el usuario). La numeraci√≥n deber√≠a actualizarse autom√°ticamente cuando se agregan, eliminan o reordenan reglas.

9) Agregar una funcionalidad de filtro para reglas de precios. Actualmente, cuando hay muchas reglas de precios en una lista, es dif√≠cil encontrar una regla espec√≠fica para editarla. Se requiere poder filtrar las reglas por texto libre y que a medida que se escribe el texto, se vayan mostrando s√≥lo las reglas que coinciden con el texto ingresado, tanto en la condici√≥n como en la acci√≥n de la regla, mostrando tambi√©n la pesta√±a a la que pertenece la regla (aunque la pesta√±a no coincida con el filtro) y el n√∫mero de regla (si se implementa el punto 8). Al presionar en una regla filtrada, se debe mostrar la pesta√±a correspondiente y hacer scroll autom√°tico hasta la regla seleccionada, quedando esta marcada visualmente para facilitar su identificaci√≥n (actualmente eso ya sucede, cuando se hace click sobre una regla en el listado de reglas, la misma queda marcada con un color de fondo diferente).

10) Poder duplicar reglas de precios dentro de la misma lista de precios. Actualmente no hay forma de duplicar una regla, lo que obliga a recrearla manualmente si se quiere hacer una regla similar a otra ya existente.

---

En cada caso, se debe revisar exhaustivamente:
- El archivo CLAUDE.md y todos los archivos relacionados para entender c√≥mo hacer las tareas necesarias para cada requerimiento.
- La documentaci√≥n existente sobre listas de precios y reglas de precios (listas_precios.txt y reglas_precios.txt). En este caso, te pido que obtengas de esas p√°ginas de dokuwiki tambi√©n las capturas de pantalla (por ejemplo, ayuda_price-lists_crear.png) y las analices para entender bien c√≥mo funciona el sistema actualmente y poder evaluar la forma de implementar cada mejora y su complejidad.
- El c√≥digo fuente relevante, tanto en frontend como en backend, para entender c√≥mo se implementa actualmente el mecanismo de listas de precios y reglas de precios:
    - frontend/utils/PriceListCalc.php
    - frontend/utils/ViajesCostService.php
    - frontend/utils/PriceListsService.php
    - frontend/models/PriceLists.php
    - frontend/controllers/PriceListsController.php
    - frontend/views/price-lists/*
    - frontend/web/js/pricecalc.js
    - frontend/web/js/pricelists.js
    - frontend/web/js/pricerules.js
    - frontend/web/js/viajes-all.js (funciones getWaitingPrice(), getDistancePrice() y processPriceListVariables(), y su utilizaci√≥n desde frontend/web/js/viajes.js y frontend/web/js/viajes-route.js)

---

El primer entregable debe ser un an√°lisis detallado de la factibilidad y complejidad de cada mejora, incluyendo por el momento √∫nicamente:
- An√°lisis funcional de los cambios necesarios
- Riesgos asociados a cada mejora
- Dependencias entre mejoras (si las hubiera)
- Posibles enfoques para implementar cada mejora
- Estimaci√≥n del esfuerzo necesario para implementar cada mejora (en horas/hombre).

Documenta todo en este mismo archivo sin borrar el texto original.

---

## üî¥ AN√ÅLISIS DE FACTIBILIDAD Y COMPLEJIDAD

**Fecha de an√°lisis**: 2026-01-08

**Resumen**: Se analizan 10 mejoras propuestas para el sistema de Listas de Precios. El an√°lisis incluye factibilidad t√©cnica, complejidad, riesgos, dependencias y estimaci√≥n de esfuerzo.

---

### 1. M√∫ltiples acciones por regla

**Descripci√≥n**: Permitir que una regla tenga varias acciones asociadas (ej: descuento 10% + cargo fijo $50).

**An√°lisis de Factibilidad**: ‚úÖ **FACTIBLE**

**Complejidad**: MEDIA-ALTA

**Archivos a modificar**:
- `frontend/models/PriceLists.php` - Actualizar validaci√≥n de `price_rules`
- `frontend/views/price-lists/_form.php` - Modificar UI para permitir m√∫ltiples acciones
- `frontend/web/js/pricerules.js` - Refactorizar `savePricerule()`, `editPricerule()`, `getTableHtmlPricerule()` para manejar array de acciones
- `frontend/web/js/pricecalc.js` - Modificar los 3 m√©todos de c√°lculo para iterar sobre array de acciones
- `frontend/utils/PriceListCalc.php` - Equivalente en PHP
- `console/migrations/` - Migraci√≥n para convertir estructura existente

**Estructura de datos propuesta**:
```json
// Antes (actual):
{ "type": "addvalue", "value": 50, "stop": 0, ... }

// Despu√©s:
{
  "actions": [
    { "type": "subpercentage", "value": 10 },
    { "type": "addvalue", "value": 50 }
  ],
  "stop": 0,
  ...
}
```

**Migraci√≥n requerida**:
```php
// Convertir cada regla existente:
// { "type": "X", "value": Y, ... } ‚Üí { "actions": [{ "type": "X", "value": Y }], ... }
```

**Riesgos**:
- Migraci√≥n de datos de todas las agencias
- Cambio estructural significativo que afecta JS frontend + PHP backend
- Requiere actualizar impresi√≥n de listas de precios
- UI necesita redise√±o para mostrar m√∫ltiples acciones

**Estimaci√≥n**: 24-32 horas

---

### 2. Reglas para modificar datos/valores del viaje

**Descripci√≥n**: Permitir que las reglas activen/desactiven tildes, modifiquen valores num√©ricos del viaje, y seleccionen destino frecuente.

**An√°lisis de Factibilidad**: ‚ö†Ô∏è **FACTIBLE CON COMPLEJIDAD ALTA**

**Complejidad**: ALTA

**Sub-funcionalidades**:

**2a) Activar/desactivar tildes (checks)**:
- Ya existe parcialmente con `set_var`/`unset_var` para USE_VAT2 y INCLUDE_BASE_DISTANCES
- Extender para cualquier check del viaje
- Archivos: `viajes-all.js`, `processPriceListVariables()`, `PriceListCalc.php`

**2b) Modificar valores num√©ricos del viaje**:
- Nueva categor√≠a de acciones: `set_trip_field`
- Ejemplo: `{ "type": "set_trip_field", "field": "night_charge", "value": 100 }`
- Requiere agregar campos al modelo Viajes si no existen (ej: `night_charge`)
- Archivos: modelos, vistas, funciones de c√°lculo

**2c) Seleccionar destino frecuente**:
- Nueva acci√≥n: `{ "type": "set_frequent", "value": "Aeroparque - Ezeiza" }`
- Actualizar `#viajes-destino_frecuente` en frontend
- Archivos: `viajes-all.js`, `viajes.js`

**Riesgos**:
- Complejidad del ciclo de rec√°lculo (ver ViajesCostService::processPriceListVariables)
- Efectos secundarios al modificar campos del viaje durante el c√°lculo
- Loops infinitos si una regla modifica un valor que afecta las condiciones de otras reglas
- Necesita mecanismo para detectar y evitar recursi√≥n infinita

**Dependencias**: Depende parcialmente de mejora #1 (m√∫ltiples acciones) para implementaci√≥n limpia.

**Estimaci√≥n**: 40-56 horas (incluyendo todas las sub-funcionalidades)

---

### 3. Unificar "acciones complementarias" como acciones normales

**Descripci√≥n**: Convertir `set_var`/`unset_var`/`stop` en acciones type/value normales.

**An√°lisis de Factibilidad**: ‚úÖ **FACTIBLE**

**Complejidad**: MEDIA

**Dependencias**: Debe implementarse junto con mejora #1.

**Estructura de datos propuesta**:
```json
// Antes:
{ "type": "addvalue", "value": 50, "stop": 1, "set_var": "NOCTURNO" }

// Despu√©s:
{
  "actions": [
    { "type": "addvalue", "value": 50 },
    { "type": "set_var", "value": "NOCTURNO" },
    { "type": "stop_rules", "value": 1 }
  ]
}
```

**Archivos a modificar**:
- Los mismos que mejora #1
- Migraci√≥n adicional para convertir `stop`, `set_var`, `unset_var`

**Riesgos**:
- Rompe compatibilidad hacia atr√°s
- Migraci√≥n de datos m√°s compleja

**Estimaci√≥n**: 8-12 horas (adicionales a mejora #1)

---

### 4. Pesta√±as (tabs) de reglas de precios

**Descripci√≥n**: Agrupar reglas en pesta√±as con nombres personalizados.

**An√°lisis de Factibilidad**: ‚úÖ **FACTIBLE**

**Complejidad**: ALTA

**Estructura de datos propuesta**:
```json
// Campo price_rules actual:
[{rule1}, {rule2}, ...]

// Campo price_rules nuevo:
{
  "tabs": [
    { "name": "Tarifas base", "rules": [{rule1}, {rule2}] },
    { "name": "Nocturnos", "rules": [{rule3}, {rule4}] },
    { "name": "Zonas especiales", "rules": [{rule5}] }
  ]
}
```

**Archivos a modificar**:
- `frontend/views/price-lists/_form.php` - Agregar UI de pesta√±as
- `frontend/web/js/pricerules.js` - Refactorizar completamente para manejar tabs
- `frontend/web/js/pricecalc.js` - Iterar sobre todas las pesta√±as en orden
- `frontend/utils/PriceListCalc.php` - Equivalente en PHP
- `frontend/web/css/pricerules.css` - Estilos para pesta√±as
- Migraci√≥n para convertir estructura plana a estructura con tabs

**Notas de UI**:
- Tabs con bot√≥n (+) para agregar nueva pesta√±a
- Click derecho o men√∫ para renombrar/eliminar pesta√±a
- Drag & drop para reordenar pesta√±as
- Drag & drop de reglas entre pesta√±as

**Riesgos**:
- Cambio estructural muy significativo
- Mayor complejidad de UI
- Migraci√≥n de datos existentes (lista plana ‚Üí estructura con una pesta√±a "Principal")

**Estimaci√≥n**: 32-48 horas

---

### 5. Copiar pesta√±as entre listas de precios

**Descripci√≥n**: Copiar pesta√±as completas con sus reglas entre diferentes listas de precios.

**An√°lisis de Factibilidad**: ‚úÖ **FACTIBLE**

**Complejidad**: MEDIA

**Dependencias**: Requiere mejora #4 implementada primero.

**Archivos a modificar**:
- `frontend/views/price-lists/_form.php` - Bot√≥n "Copiar pesta√±a desde otra lista" y "Copiar pesta√±a a otras listas"
- `frontend/controllers/PriceListsController.php` - Nuevas acciones AJAX:
  - `actionCopyTabFrom($id_source_list, $tab_name)`
  - `actionCopyTabTo($id_dest_lists[], $tab_name, $replace_if_exists)`
- `frontend/web/js/pricelists.js` - Funciones JS para UI de copiado
- Modal para seleccionar lista fuente/destino y pesta√±a

**Flujo de usuario**:
1. Bot√≥n "Importar pesta√±a" ‚Üí Modal con dropdown de listas ‚Üí dropdown de pesta√±as ‚Üí Confirmar
2. Si pesta√±a ya existe: "¬øReemplazar o cancelar?"
3. Bot√≥n "Exportar pesta√±a a otras listas" ‚Üí Multi-select de listas destino ‚Üí Confirmar

**Riesgos**:
- Validaciones de permisos (solo listas de la misma agencia)
- Manejo de conflictos de nombres de pesta√±as

**Estimaci√≥n**: 16-24 horas (despu√©s de mejora #4)

---

### 6. Calcular precio por zona y precio por kil√≥metro separados

**Descripci√≥n**: Calcular dos precios: uno con zonas y otro "puro" por kil√≥metros, y opcionalmente usar el mayor.

**An√°lisis de Factibilidad**: ‚ö†Ô∏è **FACTIBLE CON COMPLEJIDAD SIGNIFICATIVA**

**Complejidad**: ALTA

**An√°lisis t√©cnico**:
La funci√≥n `calcDistancePrice()` tendr√≠a que:
1. Ejecutar las reglas normalmente ‚Üí `priceWithZones`
2. Ejecutar las reglas ignorando condiciones `zone` ‚Üí `pricePureKm`
3. Si par√°metro activo y `pricePureKm > priceWithZones` ‚Üí usar `pricePureKm`

**Archivos a modificar**:
- `frontend/web/js/pricecalc.js` - Agregar segundo c√°lculo sin zonas
- `frontend/utils/PriceListCalc.php` - Equivalente PHP
- `frontend/models/PriceLists.php` - Nuevo campo `use_higher_price`
- `frontend/views/price-lists/_form.php` - Checkbox para activar comportamiento
- Migraci√≥n para nuevo campo en tabla `price_lists`

**L√≥gica propuesta**:
```javascript
function calcDistancePrice(...) {
  // C√°lculo normal
  let priceWithZones = calculateWithAllRules(pricerules, ...);

  // C√°lculo sin zonas
  let rulesWithoutZones = pricerules.filter(r => !r.zone);
  let pricePureKm = calculateWithAllRules(rulesWithoutZones, ...);

  if (price_list.use_higher_price && pricePureKm > priceWithZones) {
    return { price: pricePureKm, usedPureKm: true, ... };
  }
  return { price: priceWithZones, usedPureKm: false, ... };
}
```

**Riesgos**:
- Duplica el tiempo de c√°lculo
- Complejidad para debug/entender qu√© precio se us√≥
- Posible confusi√≥n de usuarios

**Estimaci√≥n**: 16-24 horas

---

### 7. Minutos incluidos en viaje (para TBD y similar)

**Descripci√≥n**: Nueva acci√≥n de regla que define minutos incluidos en un precio fijo. Tiempo excedente se cobra como espera.

**An√°lisis de Factibilidad**: ‚úÖ **FACTIBLE**

**Complejidad**: MEDIA

**Archivos a modificar**:
- `frontend/views/price-lists/_form.php` - Nueva opci√≥n en dropdown de acciones: "Minutos incluidos son"
- `frontend/web/js/pricerules.js` - Agregar opci√≥n
- `frontend/web/js/pricecalc.js` - Modificar `calcWaitingPrice()` para considerar `included_minutes`
- `frontend/utils/PriceListCalc.php` - Equivalente en PHP

**Estructura de datos**:
```json
{ "type": "includedminutes", "value": 60 }
```

**L√≥gica de c√°lculo**:
```javascript
// En calcWaitingPrice():
let includedMinutes = 0; // De las reglas de precios

// Durante iteraci√≥n de reglas:
case 'includedminutes':
  includedMinutes = pricerulevalue;
  break;

// Al calcular:
let tripDuration = ...; // Duraci√≥n total del viaje en minutos
let waitingTime = ...; // Tiempo de espera registrado
let totalTimeToCharge = Math.max(0, tripDuration - includedMinutes) + waitingTime;
let finalPrice = calcWaitingPriceFromMinutes(totalTimeToCharge, ...);
```

**Riesgos**:
- Requiere que el viaje tenga registrada la duraci√≥n total (no solo tiempo de espera)
- Verificar que el campo de duraci√≥n del viaje est√© disponible en el c√°lculo

**Datos necesarios**:
- ¬øExiste campo `trip_duration` en el modelo Viajes? Si no, agregar.
- Alternativamente, calcular de `hora_cierre - hora_inicio`

**Estimaci√≥n**: 12-16 horas

---

### 8. Numerar las reglas de precios

**Descripci√≥n**: Mostrar n√∫mero secuencial (1, 2, 3...) en cada regla para facilitar referencia.

**An√°lisis de Factibilidad**: ‚úÖ **FACTIBLE - SIMPLE**

**Complejidad**: BAJA

**Archivos a modificar**:
- `frontend/web/js/pricerules.js` - Modificar `getTableHtmlPricerule()` para agregar n√∫mero

**C√≥digo actual** (l√≠nea 286-316 de pricerules.js):
```javascript
htmldata += '<tr id="pr_' + i + '"><td onclick="togglePriceruleRow(' + i + ')">';
```

**C√≥digo modificado**:
```javascript
htmldata += '<tr id="pr_' + i + '"><td onclick="togglePriceruleRow(' + i + ')">';
htmldata += '<span class="rule-number">' + (i + 1) + '</span> '; // Agregar n√∫mero
```

**CSS** (pricerules.css):
```css
.rule-number {
  color: #888;
  font-weight: bold;
  margin-right: 5px;
}
```

**Riesgos**: Ninguno significativo.

**Estimaci√≥n**: 2-3 horas

---

### 9. Filtro de b√∫squeda para reglas de precios

**Descripci√≥n**: Input de texto para filtrar reglas mostrando solo las que coinciden.

**An√°lisis de Factibilidad**: ‚úÖ **FACTIBLE**

**Complejidad**: MEDIA

**Archivos a modificar**:
- `frontend/views/price-lists/_form.php` - Agregar input de filtro
- `frontend/web/js/pricerules.js` - Funci√≥n de filtrado
- `frontend/web/css/pricerules.css` - Estilos para resultados filtrados

**UI propuesta**:
- Input de texto arriba de la tabla de reglas
- Busca en: texto de condiciones + texto de acciones
- Filtrado en tiempo real (keyup)
- Al hacer click en resultado filtrado: expandir pesta√±a correcta (si aplica) + scroll + highlight

**C√≥digo propuesto**:
```javascript
function filterRules(searchText) {
  if (!searchText) {
    // Mostrar todas
    $('#rulestable tr').show();
    return;
  }
  searchText = searchText.toLowerCase();
  $('#rulestable tr').each(function() {
    let ruleText = $(this).text().toLowerCase();
    if (ruleText.indexOf(searchText) >= 0) {
      $(this).show();
    } else {
      $(this).hide();
    }
  });
}

// En input: oninput="filterRules(this.value)"
```

**Si hay pesta√±as (mejora #4)**:
- Mostrar en resultados: "[Tab: Nocturnos] #5 Si Hora entre 22 y 06..."
- Al hacer click: `showTab('Nocturnos'); scrollToRule(5);`

**Riesgos**: Bajo, funcionalidad aislada.

**Estimaci√≥n**: 8-12 horas (6-8h sin pesta√±as, +4h con pesta√±as)

---

### 10. Duplicar reglas de precios

**Descripci√≥n**: Bot√≥n para duplicar una regla existente.

**An√°lisis de Factibilidad**: ‚úÖ **FACTIBLE - SIMPLE**

**Complejidad**: BAJA

**Archivos a modificar**:
- `frontend/views/price-lists/_form.php` - Agregar bot√≥n de duplicar
- `frontend/web/js/pricerules.js` - Funci√≥n `duplicatePricerule(pos)`

**C√≥digo propuesto**:
```javascript
// En getTableHtmlPricerule(), agregar bot√≥n junto a editar/eliminar:
htmldata += '<button type="button" class="btn btn-xs btn-gray" onclick="duplicatePricerule(' + i + ')"><span class="glyphicon glyphicon-duplicate"></span></button>';

function duplicatePricerule(pos) {
  // Clonar la regla
  let newRule = JSON.parse(JSON.stringify(pricerules[pos]));
  // Insertar despu√©s de la regla actual
  pricerules.splice(pos + 1, 0, newRule);
  // Actualizar hidden field y re-renderizar
  $("#pricelists-price_rules").val(JSON.stringify(pricerules));
  $("#pricesrezisable").html(getTableHtmlPricerule());
  // Marcar la nueva regla
  markPricerule(pos + 1, false);
  blinkInput('pr_' + (pos + 1), 'ruleBlinkClass');
}
```

**Riesgos**: Ninguno significativo.

**Estimaci√≥n**: 2-3 horas

---

## Resumen de Factibilidad y Estimaciones

| # | Mejora | Factibilidad | Complejidad | Horas Est. | Dependencias |
|---|--------|--------------|-------------|------------|--------------|
| 1 | M√∫ltiples acciones por regla | ‚úÖ | Media-Alta | 24-32h | - |
| 2 | Reglas para modificar viaje | ‚ö†Ô∏è | Alta | 40-56h | Parcial de #1 |
| 3 | Unificar acciones complementarias | ‚úÖ | Media | 8-12h | Requiere #1 |
| 4 | Pesta√±as de reglas | ‚úÖ | Alta | 32-48h | - |
| 5 | Copiar pesta√±as entre listas | ‚úÖ | Media | 16-24h | Requiere #4 |
| 6 | Precio por zona vs kil√≥metro | ‚ö†Ô∏è | Alta | 16-24h | - |
| 7 | Minutos incluidos en viaje | ‚úÖ | Media | 12-16h | - |
| 8 | Numerar reglas | ‚úÖ | Baja | 2-3h | - |
| 9 | Filtro de b√∫squeda | ‚úÖ | Media | 8-12h | Opcional #4 |
| 10 | Duplicar reglas | ‚úÖ | Baja | 2-3h | - |

**Total estimado**: 160-230 horas

---

## Dependencias entre Mejoras

```
#1 (M√∫ltiples acciones)
  ‚îî‚îÄ‚îÄ #3 (Unificar acciones complementarias)
  ‚îî‚îÄ‚îÄ #2 (Reglas para modificar viaje) - parcial

#4 (Pesta√±as)
  ‚îî‚îÄ‚îÄ #5 (Copiar pesta√±as)
  ‚îî‚îÄ‚îÄ #9 (Filtro) - mejora opcional

#8, #10 - Independientes, se pueden hacer en cualquier momento
#6, #7 - Independientes
```

---

## Orden de Implementaci√≥n Recomendado

**Fase 1 - Quick wins (4-6h)**:
- #8 Numerar reglas
- #10 Duplicar reglas

**Fase 2 - Mejoras estructurales (56-68h)**:
- #1 M√∫ltiples acciones por regla
- #3 Unificar acciones complementarias

**Fase 3 - Organizaci√≥n visual (40-60h)**:
- #4 Pesta√±as de reglas
- #5 Copiar pesta√±as entre listas
- #9 Filtro de b√∫squeda

**Fase 4 - Funcionalidades avanzadas (68-96h)**:
- #2 Reglas para modificar viaje
- #6 Precio por zona vs kil√≥metro
- #7 Minutos incluidos en viaje

---

## Riesgos Generales

1. **Migraci√≥n de datos**: Las mejoras #1, #3, #4 requieren migraciones que transforman la estructura de `price_rules`. Se deben implementar con cuidado y probar exhaustivamente.

2. **Paridad JS/PHP**: Todas las mejoras de c√°lculo deben implementarse tanto en `pricecalc.js` como en `PriceListCalc.php`. Cualquier discrepancia causar√° diferencias entre precios en frontend y backend.

3. **Regresiones**: El sistema de listas de precios es cr√≠tico. Cada cambio debe incluir pruebas de regresi√≥n con viajes existentes.

4. **Ciclos de rec√°lculo**: La mejora #2 puede introducir loops infinitos si una regla modifica valores que afectan las condiciones de otras reglas. Se necesita un mecanismo de detecci√≥n.

---

## Testing Strategy

Para cada mejora:
1. Unit tests en `frontend/unit/utils/PriceListCalcTest.php`
2. Verificaci√≥n de paridad JS/PHP con mismos datos de entrada
3. Pruebas de migraci√≥n en base de datos de staging
4. Pruebas de regresi√≥n con listas de precios existentes de clientes reales
5. Pruebas de UI en browser

---

---

## üîµ AN√ÅLISIS UX: MEJORAS EN LA EDICI√ìN DE REGLAS DE PRECIOS

**Fecha de an√°lisis**: 2026-01-08

**Objetivo**: Investigar y proponer mejoras de UX/UI para hacer la edici√≥n de reglas de precios m√°s intuitiva.

### Exploraci√≥n Realizada

Se explor√≥ el editor de reglas de precios en `http://localhost/price-lists/update?id=46333` (Lista "GS Remises 2023 Ene" con ~300+ reglas).

**Observaciones del editor actual**:

1. **Vista de lista**:
   - Todas las reglas aparecen en una lista plana sin numeraci√≥n
   - Cada regla muestra condiciones + acci√≥n en una sola l√≠nea
   - Botones: editar (l√°piz), eliminar (papelera), drag-handle (reordenar)
   - Se puede seleccionar una regla haciendo clic (queda con fondo destacado)
   - Selecci√≥n m√∫ltiple disponible con checkbox

2. **Flujo de edici√≥n**:
   - Al hacer clic en "editar" (l√°piz), la regla se carga en el formulario superior
   - Las condiciones aparecen como **tags removibles** (ej: "Tipo de Servicio es Auto Sedan Remis ‚úï")
   - Un dropdown "Agregar" permite a√±adir m√°s condiciones
   - El resultado se selecciona en dropdown + valor en textbox
   - Botones confirmar (‚úì) y cancelar (‚úï)
   - La regla **permanece en su posici√≥n original** en la lista durante la edici√≥n

3. **Ejemplo observado** (regla con 3 condiciones):
   - Condiciones: "Tipo de Servicio es Auto Sedan Remis", "Destino Frecuente es Centro - Ezeiza Aeropuerto", "Con Espera y Retorno"
   - Resultado: "Agrega %" con valor "50"

---

### Puntos de Dolor Identificados (UX Pain Points)

| # | Problema | Impacto | Severidad |
|---|----------|---------|-----------|
| 1 | **Desconexi√≥n visual**: El formulario de edici√≥n est√° arriba, pero la regla est√° en la lista (a veces fuera del viewport) | Dif√≠cil saber qu√© regla se est√° editando | ALTA |
| 2 | **Sin numeraci√≥n**: No hay n√∫meros de regla para referencia | Dif√≠cil comunicar "la regla 47 tiene un error" | MEDIA |
| 3 | **Lista plana**: 300+ reglas sin agrupaci√≥n visual | Dif√≠cil encontrar reglas relacionadas | ALTA |
| 4 | **Sin b√∫squeda**: No hay forma de filtrar/buscar reglas | Encontrar una regla espec√≠fica requiere scroll manual | ALTA |
| 5 | **Una acci√≥n por regla**: Se necesitan m√∫ltiples reglas para condiciones similares | M√°s reglas = m√°s complejidad | MEDIA |
| 6 | **No hay preview**: No se ve c√≥mo quedar√° la regla antes de confirmar | Errores se detectan despu√©s | BAJA |
| 7 | **Condiciones sin orden**: Las condiciones aparecen como tags sin orden l√≥gico | Puede confundir el orden de evaluaci√≥n | BAJA |
| 8 | **Sin tooltips**: Los nombres abreviados no tienen explicaci√≥n | Usuarios nuevos se confunden | MEDIA |

---

### Investigaci√≥n de Patrones UX Modernos

**Patrones estudiados**:
- Adobe Experience Manager Rules Builder
- Zapier Automation Rules
- Gmail Filters
- PatternFly Rule Builder
- SAP Fiori Business Rules

**Conclusiones de la investigaci√≥n**:

1. **Card-based Rule Editor**: Cada regla es una "tarjeta" expandible con todos sus detalles, en lugar de una fila de tabla.

2. **Inline Editing**: La edici√≥n ocurre "en el lugar" donde est√° la regla, no en un formulario separado.

3. **Collapsible Groups**: Las reglas se agrupan en secciones colapsables (similar a las pesta√±as propuestas, pero m√°s visual).

4. **Visual Condition Builder**: Las condiciones se muestran como bloques visuales conectados (AND/OR expl√≠cito).

5. **Drag & Drop**: Reordenamiento intuitivo con feedback visual claro.

6. **Search & Filter**: B√∫squeda instant√°nea con highlight de coincidencias.

---

### Propuestas de Mejora UX

#### Propuesta A: **Editor de Reglas en Tarjetas (Card-Based)**

**Concepto**: Reemplazar la tabla de filas por tarjetas expandibles.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ #1 üì¶ [Tipo Servicio: Auto Sedan] [Dest. Frecuente: Centro-Ezeiza]  ‚îÇ
‚îÇ    ‚Üí Agrega 50%                                            [‚ñº] [‚ãÆ]  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ #2 üì¶ [Hora: 22:00-06:00]                                           ‚îÇ
‚îÇ    ‚Üí Agrega 20% (nocturno)                                 [‚ñº] [‚ãÆ]  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚ñº EXPANDIDO - Modo Edici√≥n                                         ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ   SI:  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  Y  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                       ‚îÇ
‚îÇ        ‚îÇ Hora entre   ‚îÇ     ‚îÇ + Agregar    ‚îÇ                       ‚îÇ
‚îÇ        ‚îÇ 22:00 - 06:00‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                       ‚îÇ
‚îÇ        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                            ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ   ENTONCES:  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                  ‚îÇ
‚îÇ              ‚îÇ Agrega %  ‚îÇ  20  ‚îÇ                                  ‚îÇ
‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                  ‚îÇ
‚îÇ              [+ Agregar otra acci√≥n]                               ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ   ‚òê Detener reglas despu√©s de esta                                 ‚îÇ
‚îÇ                                                 [Cancelar] [Guardar]‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Beneficios**:
- Edici√≥n inline (sin desconexi√≥n visual)
- Contexto visual claro
- Espacio para m√∫ltiples acciones
- Preview integrado

**Complejidad**: ALTA (redise√±o completo de UI)

**Estimaci√≥n adicional**: 40-60 horas

---

#### Propuesta B: **Mejora Incremental del Editor Actual**

**Concepto**: Mantener la estructura actual pero mejorar puntos cr√≠ticos.

**Cambios propuestos**:

1. **Numeraci√≥n visible** (ya planificado en #8): 2-3h

2. **B√∫squeda con highlight** (ya planificado en #9): 8-12h

3. **Mini-preview en formulario**:
   - Mostrar c√≥mo se ver√° la regla debajo del formulario de edici√≥n
   - **Estimaci√≥n**: 4-6h

4. **Scroll autom√°tico a regla editada**:
   - Cuando se hace clic en editar, hacer scroll suave hasta la regla
   - Agregar borde de color (ej: azul) a la regla en edici√≥n
   - **Estimaci√≥n**: 2-4h

5. **Tooltips informativos**:
   - Hover sobre condiciones/acciones muestra descripci√≥n completa
   - **Estimaci√≥n**: 4-6h

6. **Indicador de posici√≥n**:
   - "Editando regla #47 de 312"
   - **Estimaci√≥n**: 1-2h

**Beneficios**:
- Menor riesgo (cambios incrementales)
- Compatibilidad con estructura actual
- Implementaci√≥n m√°s r√°pida

**Estimaci√≥n total Propuesta B**: 20-30 horas adicionales

---

#### Propuesta C: **Agrupaci√≥n Visual por Tipo de Servicio**

**Concepto**: Agrupar autom√°ticamente las reglas por el primer tipo de servicio en sus condiciones.

```
‚îå‚îÄ‚îÄ‚îÄ Auto Sedan Remis (45 reglas) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [‚àí] ‚îÄ‚îÄ‚îê
‚îÇ #1  [Dest. Frecuente: Centro-Ezeiza] ‚Üí Agrega 50%          ‚îÇ
‚îÇ #2  [Km Totales >= 30] ‚Üí Precio m√≠nimo $5000               ‚îÇ
‚îÇ #3  ...                                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ Van/Combi (28 reglas) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [‚àí] ‚îÄ‚îÄ‚îê
‚îÇ #46 [Dest. Frecuente: Centro-Ezeiza] ‚Üí Agrega 60%          ‚îÇ
‚îÇ #47 ...                                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ Sin Tipo de Servicio (15 reglas) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [‚àí] ‚îÄ‚îÄ‚îê
‚îÇ #74 [Hora: 22:00-06:00] ‚Üí Agrega 20%                       ‚îÇ
‚îÇ ...                                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Beneficios**:
- Vista organizada sin cambiar estructura de datos
- Colapsar/expandir grupos reduce ruido visual
- Compatible con pesta√±as (#4) como segunda capa de organizaci√≥n

**Notas**:
- La agrupaci√≥n es solo visual, el orden de ejecuci√≥n sigue siendo lineal
- Requiere indicador claro del orden real de ejecuci√≥n

**Estimaci√≥n**: 16-24 horas

---

### Recomendaci√≥n UX

**Implementaci√≥n recomendada en 3 fases**:

**Fase UX-1: Quick Wins (4-6h)**
- #8 Numerar reglas (2-3h)
- Scroll autom√°tico a regla editada + borde destacado (2-3h)

**Fase UX-2: Mejoras de Usabilidad (16-22h)**
- #9 Filtro de b√∫squeda (8-12h)
- Mini-preview en formulario (4-6h)
- Tooltips informativos (4-6h)

**Fase UX-3: Organizaci√≥n Visual (32-48h)**
- #4 Pesta√±as de reglas (implementaci√≥n actual)
- O alternativamente: Agrupaci√≥n visual autom√°tica (Propuesta C)

**Fase UX-4: Redise√±o Mayor (opcional, 40-60h)**
- Propuesta A: Editor en tarjetas (solo si las fases anteriores no son suficientes)

---

### Resumen de Estimaciones UX

| Mejora | Horas | Ya planificada |
|--------|-------|----------------|
| Numerar reglas | 2-3h | ‚úÖ #8 |
| Scroll + borde destacado | 2-3h | ‚ùå Nueva |
| Filtro b√∫squeda | 8-12h | ‚úÖ #9 |
| Mini-preview | 4-6h | ‚ùå Nueva |
| Tooltips | 4-6h | ‚ùå Nueva |
| Indicador posici√≥n | 1-2h | ‚ùå Nueva |
| Pesta√±as | 32-48h | ‚úÖ #4 |
| Agrupaci√≥n visual (alt) | 16-24h | ‚ùå Nueva |
| Editor en tarjetas | 40-60h | ‚ùå Nueva |

**Total mejoras UX nuevas (sin contar las ya planificadas)**: 25-40 horas

---

### An√°lisis del C√≥digo Existente

**Archivos clave revisados**:

1. **[frontend/utils/PriceListsService.php](frontend/utils/PriceListsService.php)** (806 l√≠neas)
   - `enrichPriceRules()`: Convierte reglas JSON a texto legible para humanos
   - `getPriceListTypes()`: Define los ~26 tipos de acciones disponibles
   - `getPriceConditionDescriptions()`: Describe las ~14 condiciones posibles
   - `getZonePriceRuleText()`: Genera texto para condiciones de zona
   - `getPriceRulePromptDescription()`: Genera descripci√≥n para IA/prompts

2. **[frontend/web/js/pricerules.js](frontend/web/js/pricerules.js)** (1112 l√≠neas)
   - `savePricerule()`: Valida y guarda una regla
   - `editPricerule(pos)`: Carga regla en formulario para edici√≥n
   - `getTableHtmlPricerule()`: Genera HTML de la tabla de reglas
   - `displayCurrentConditions()`: Muestra condiciones como tags clickeables
   - `scrollToRowInTable()` / `scrollToRowInViewport()`: **YA EXISTE** scroll autom√°tico
   - `markPricerule()`: Marca/desmarca regla seleccionada
   - `togglemultiple()`: Habilita selecci√≥n m√∫ltiple

**Hallazgos importantes del c√≥digo**:

| Funcionalidad | Estado | Ubicaci√≥n |
|---------------|--------|-----------|
| Scroll a regla en tabla | ‚úÖ Existe | `scrollToRowInTable()` l√≠nea 210 |
| Scroll a viewport | ‚úÖ Existe | `scrollToRowInViewport()` l√≠nea 222 |
| CSS para regla en edici√≥n | ‚úÖ Existe | `.ruleEditingClass` |
| CSS para regla seleccionada | ‚úÖ Existe | `.ruleSelectedClass` |
| Selecci√≥n m√∫ltiple | ‚úÖ Existe | `togglemultiple()` l√≠nea 1052 |
| Drag & drop para reordenar | ‚úÖ Existe | jQuery UI Sortable |
| Autocomplete srvtype/frequent | ‚úÖ Existe | `setAutocompleteSrvtype()` l√≠nea 343 |
| Numeraci√≥n de reglas | ‚ùå No existe | - |
| B√∫squeda/filtro | ‚ùå No existe | - |

**Estructura JSON de una regla**:
```json
{
  "type": "addpercentage",      // Acci√≥n (obligatorio)
  "value": "50",                // Valor (obligatorio)
  "stop": 0,                    // Detener reglas (0/1)
  "srvtype": "Auto Sedan",      // Condici√≥n: tipo servicio
  "frequent": "Centro-Ezeiza",  // Condici√≥n: destino frecuente
  "hourMin": "22",              // Condici√≥n: hora m√≠nima
  "hourMax": "05",              // Condici√≥n: hora m√°xima
  "km": "30",                   // Condici√≥n: km totales >=
  "kmless": "50",               // Condici√≥n: km totales <=
  "unittype": "123",            // Condici√≥n: tipo unidad (ID)
  "check": "check-return",      // Condici√≥n: opcional seleccionado
  "is_var": "VAR_ID",           // Condici√≥n: variable prendida
  "isnt_var": "VAR_ID",         // Condici√≥n: variable apagada
  "zone": "ZONE_FROM_IS",       // Condici√≥n: tipo zona
  "zoneFrom": "123",            // Condici√≥n: zona origen (ID)
  "zoneTo": "456",              // Condici√≥n: zona destino (ID)
  "set_var": "VAR_ID",          // Acci√≥n complementaria: prender variable
  "unset_var": "VAR_ID"         // Acci√≥n complementaria: apagar variable
}
```

**Observaci√≥n importante**: El scroll autom√°tico YA EXISTE en el c√≥digo (`scrollToRowInTable` y `scrollToRowInViewport`), pero se ejecuta al **guardar** la regla, no al **editar**. La mejora propuesta "Scroll autom√°tico a regla editada" requiere agregar estas llamadas en `editPricerule()`.

---

### Ajuste de Estimaciones (Post-An√°lisis de C√≥digo)

| Mejora | Estimaci√≥n Original | Estimaci√≥n Ajustada | Motivo |
|--------|---------------------|---------------------|--------|
| Scroll + borde destacado | 2-3h | **1-2h** | Ya existen funciones, solo agregar llamada en `editPricerule()` |
| Numerar reglas | 2-3h | 2-3h | Sin cambios |
| Filtro b√∫squeda | 8-12h | 8-12h | Sin cambios |
| Mini-preview | 4-6h | 4-6h | Sin cambios |
| Tooltips | 4-6h | **3-4h** | Puede usar `title` HTML simple |

**Total ajustado mejoras UX nuevas**: 20-30 horas (antes: 25-40h)
