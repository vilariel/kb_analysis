# Ticket 6063 - Mejoras en las listas de precios

Se requiere analizar la factibilidad y complejidad de las siguientes mejoras relacionadas con las reglas de precios y el cÃ¡lculo de precios.

## DescripciÃ³n de mejoras solicitadas

### 1. MÃºltiples acciones por regla

Que las reglas de precios tengan varias acciones asociadas, no solo una. Por ejemplo, una regla podrÃ­a aplicar un descuento del 10% y ademÃ¡s agregar un cargo fijo de $50. Actualmente solo se puede hacer una cosa u otra, pero no ambas a la vez.

Desde el punto de vista tÃ©cnico, la acciÃ³n de cada regla estÃ¡ definida por los atributos 'type' y 'value'. Cada regla tiene un solo par type/value (por ejemplo type='addvalue' y value='50', que significa "agregar valor fijo de $50"). Quiero modificar esto para que cada regla pueda tener mÃºltiples pares type/value asociados, y se apliquen todos cuando la condiciÃ³n se cumple. Se me ocurre que se deberÃ­a crear un nuevo atributo 'actions' que sea un array de objetos, cada uno con su propio type y value y crear una migraciÃ³n para convertir las reglas existentes a este nuevo formato.

### 2. Reglas para modificar datos/valores del viaje

Que haya reglas para modificar datos/valores del viaje. Actualmente las funciones de cÃ¡lculo de precios utilizan la lista de precios y sus reglas para determinar el precio que se estÃ© calculando (hay dos funciones para calcular el precio de la distancia (una si es por kilÃ³metros y la otra si es por tiempo de disposiciÃ³n del auto) y una tercera para calcular el precio de espera). Estas funciones, ademÃ¡s del precio calculado devuelven otros datos. Entre ellos, devuelven variables "activadas" por las reglas de precios. Al momento hay 2 variables que estÃ¡n preconfiguradas y tienen impacto en el viaje:
- USE_VAT2: Si la lista de precios activa esta variable, se activa el tilde (oculto) FIX_USE_VAT2 del viaje, que hace que, en caso de que se aplique IVA, el mismo sea al 21% en lugar del 10.5% (en realidad eso es configurable en los parÃ¡metros adicionales, pero por defecto es asÃ­).
- INCLUDE_BASE_DISTANCES: Si la lista de precios activa esta variable, se activa el tilde (oculto) FIX_INCLUDE_BASE_DISTANCES_CL o FIX_INCLUDE_BASE_DISTANCES_CH del viaje (dependiendo si la lista de precios se utilizÃ³ para el cÃ¡lculo de los precios para el cliente o para el chofer). Esto hace que a las fÃ³rmulas de distancia correspondiente se les agreguen los tramos de ida y vuelta a la base (0A, B0, y/o A0 segÃºn corresponda).

Cuando sucede esto, se requiere que haya un re-cÃ¡lculo de los precios del viaje, ya que estas variables afectan el cÃ¡lculo. De todas maneras, deberÃ­as revisar los phpdoc de las funciones ViajesCostService::calculateDistancesAndPrices() y ViajesCostService::processPriceListVariables() para entender las restricciones que tienen hoy estos mecanismos.

Lo que quiero es que una lista de precios, por medio de las acciones de sus reglas, pueda hacer lo siguiente:
- Activar y desactivar tildes (checks) del viaje (de esta manera no serÃ­a necesario crear variables especÃ­ficas como USE_VAT2, sino que se podrÃ­a activar o desactivar cualquier tilde del viaje, incluendo FIX_USE_VAT2). TambiÃ©n podrÃ­a activar o desactivar cualquier check del viaje.
- Modificar valores numÃ©ricos del viaje, como los kilÃ³metros o cualquier otro valor numÃ©rico del viaje, que pueden ser modificados por las reglas. Ejemplos:
  a) Hay una agencia que quiere que a todos los viajes que cumplen con determinada condiciÃ³n, se le sumen 2 kilÃ³metros adicionales.
  b) Otra agencia quiere detallar el valor correspondiente al cargo por viaje nocturno. Actualmente ese valor se calcula y se suma al precio total, pero no queda registrado en ningÃºn lado. Contando con una regla que modifique valores numÃ©ricos del viaje y agregando un campo `night_charge` al viaje, se podrÃ­a hacer que la regla modifique ese campo con el valor correspondiente, y luego el sistema podrÃ­a mostrar ese valor en los listados y en la impresiÃ³n del viaje.
- Seleccionar (o cambiar la selecciÃ³n de) el campo Destino Frecuente. De esa manera, si las reglas de precios que detectan las zonas de origen y destino del viaje, podrÃ­an ademÃ¡s seleccionar el destino frecuente correspondiente en el viaje. Eso permitirÃ­a que, bajo determinadas condiciones, dados 2 viajes que tienen las mismas zonas de origen y destino, uno tenga un destino frecuente seleccionado automÃ¡ticamente y el otro no.

### 3. Unificar "acciones complementarias" como acciones normales

Si hay reglas para modificar los datos/valores del viaje, entonces el mecanismo actual de activar/desactivar variables deberÃ­a hacerse de esa manera. Actualmente, las reglas de precios tienen una condiciÃ³n, una acciÃ³n (type/value) y una "acciÃ³n complementaria", que puede ser indicar que se debe detener el procesamiento de las reglas siguientes, o activar/desactivar una variable. Lo que quiero es que esa "acciÃ³n complementaria" se convierta en una acciÃ³n mÃ¡s, parecida a la de activar y desactivar tildes del viaje. De esa manera, todas las acciones de una regla estarÃ¡n en el mismo formato (type/value) y no habrÃ¡ una acciÃ³n especial para activar/desactivar variables.

### 4. PestaÃ±as (tabs) de reglas de precios

Poder agregar tabs o pestaÃ±as de reglas de precios. Actualmente todas las reglas de una lista de precios estÃ¡n en un solo listado. Quiero poder agrupar las reglas en pestaÃ±as, de manera que se puedan organizar mejor cuando hay muchas reglas. Cada pestaÃ±a tendrÃ­a su propio nombre, y dentro de cada pestaÃ±a estarÃ­an las reglas correspondientes. Las pestaÃ±as se podrÃ­an reordenar, agregar y eliminar. El orden de ejecuciÃ³n de las reglas seguirÃ­a siendo el mismo (las reglas de cada pestaÃ±a de arriba hacia abajo, y cada pestaÃ±a de izquierda a derecha).

### 5. Copiar pestaÃ±as entre listas de precios

Relacionado con el punto anterior, que se puedan copiar pestaÃ±as completas de reglas de precios entre listas de precios. Desde una lista de precios, deberÃ­a poder seleccionar una pestaÃ±a de reglas de otra lista de precios y copiarla (con todas sus reglas) a la lista de precios actual. TambiÃ©n, cuando estoy editando una lista de precios deberÃ­a poder copiar una pestaÃ±a a otras listas de precios existentes (seleccionando una o varias listas de precios destino). Si la pestaÃ±a ya existe en la lista de precios destino (mismo nombre), deberÃ­a preguntar si se quiere reemplazar la pestaÃ±a o no copiarla, ya que no quiero que haya pestaÃ±as duplicadas en una misma lista de precios.

### 6. Calcular precio por zona y precio por kilÃ³metro separados

Que la funciÃ³n de cÃ¡lculo de precios para distancia (se llama calcDistancePrice() tanto en frontend como en backend), calcule 2 precios por separado: por zona y por kilÃ³metro. Actualmente esa funciÃ³n calcula un Ãºnico precio. La forma mÃ¡s fÃ¡cil de hacerlo es que siga calculando el precio total como lo hace hoy. Pero ademÃ¡s, que calcule otro precio separado que ignore aquellas reglas que tengan condiciones basadas en zonas. Ese segundo precio serÃ­a el precio "por kilÃ³metro puro", sin considerar zonas. Adicionalmente, deberÃ­a haber un parÃ¡metro adicional o un tilde en cada lista de precios que permitiera configurar que "Si el precio por kilÃ³metro puro es mayor que el precio total calculado, usar el precio por kilÃ³metro puro".

### 7. Minutos incluidos en viaje (para TBD y similar)

El tarifario de TBD tiene indicaciones como "incluye 40' de viaje, excedente se cobra al valor de hora de espera". Si TBD define, por ejemplo, un valor fijo para los traslados desde Aeroparque a Ezeiza y que incluyen 60' de viaje, y por algÃºn motivo (problemas de trÃ¡nsito, ruta cortada, etc), ese viaje dura 80 minutos, los 20 minutos excedentes se cobran al valor de espera. Para cumplir con este requerimiento, se deberÃ­a agregar una nueva acciÃ³n de regla de precios que permita definir "minutos incluidos" en el viaje. Esa acciÃ³n serÃ­a utilizada por la funciÃ³n de cÃ¡lculo de precio de espera, para, teniendo en cuenta los minutos totales del viaje, restando los minutos incluidos definidos por la regla de precios, y sumando los minutos de espera normal (en caso de que los hubiera), para calcular el total de minutos a cobrar por espera.

### 8. Numerar las reglas de precios para mejorar la legibilidad de las mismas

Numerar las reglas de precios para mejorar la legibilidad de las mismas. Esta numeraciÃ³n sÃ³lo tiene efecto visual en la pantalla de ediciÃ³n de reglas de precios, y no afecta en nada la lÃ³gica de ejecuciÃ³n de las mismas (que sigue siendo de arriba hacia abajo segÃºn el orden definido por el usuario). La numeraciÃ³n deberÃ­a actualizarse automÃ¡ticamente cuando se agregan, eliminan o reordenan reglas.

### 9. Agregar una funcionalidad de filtro para reglas de precios

Agregar una funcionalidad de filtro para reglas de precios. Actualmente, cuando hay muchas reglas de precios en una lista, es difÃ­cil encontrar una regla especÃ­fica para editarla. Se requiere poder filtrar las reglas por texto libre y que a medida que se escribe el texto, se vayan mostrando sÃ³lo las reglas que coinciden con el texto ingresado, tanto en la condiciÃ³n como en la acciÃ³n de la regla, mostrando tambiÃ©n la pestaÃ±a a la que pertenece la regla (aunque la pestaÃ±a no coincida con el filtro) y el nÃºmero de regla (si se implementa el punto 8). Al presionar en una regla filtrada, se debe mostrar la pestaÃ±a correspondiente y hacer scroll automÃ¡tico hasta la regla seleccionada, quedando esta marcada visualmente para facilitar su identificaciÃ³n (actualmente eso ya sucede, cuando se hace click sobre una regla en el listado de reglas, la misma queda marcada con un color de fondo diferente).

### 10. Duplicar reglas de precios

Poder duplicar reglas de precios dentro de la misma lista de precios. Actualmente no hay forma de duplicar una regla, lo que obliga a recrearla manualmente si se quiere hacer una regla similar a otra ya existente.

---

En cada caso, se debe revisar exhaustivamente:
- El archivo CLAUDE.md y todos los archivos relacionados para entender cÃ³mo hacer las tareas necesarias para cada requerimiento.
- La documentaciÃ³n existente sobre listas de precios y reglas de precios (listas_precios.txt y reglas_precios.txt). En este caso, te pido que obtengas de esas pÃ¡ginas de dokuwiki tambiÃ©n las capturas de pantalla (por ejemplo, ayuda_price-lists_crear.png) y las analices para entender bien cÃ³mo funciona el sistema actualmente y poder evaluar la forma de implementar cada mejora y su complejidad.
- El cÃ³digo fuente relevante, tanto en frontend como en backend, para entender cÃ³mo se implementa actualmente el mecanismo de listas de precios y reglas de precios:
    - frontend/utils/PriceListCalc.php
    - frontend/utils/ViajesCostService.php
    - frontend/utils/PriceListsService.php
    - frontend/models/PriceLists.php
    - frontend/controllers/PriceListsController.php
    - frontend/views/price-lists/*
    - frontend/web/js/pricecalc.js
    - frontend/web/js/pricelists.js
    - frontend/web/js/pricerules.js
    - frontend/web/js/viajes-all.js (funciones getWaitingPrice(), getDistancePrice() y processPriceListVariables(), y su utilizaciÃ³n desde frontend/web/js/viajes.js y frontend/web/js/viajes-route.js)

---

El primer entregable debe ser un anÃ¡lisis detallado de la factibilidad y complejidad de cada mejora, incluyendo por el momento Ãºnicamente:
- AnÃ¡lisis funcional de los cambios necesarios
- Riesgos asociados a cada mejora
- Dependencias entre mejoras (si las hubiera)
- Posibles enfoques para implementar cada mejora
- EstimaciÃ³n del esfuerzo necesario para implementar cada mejora (en horas/hombre).

Documenta todo en este mismo archivo sin borrar el texto original.

---

## ğŸ”´ ANÃLISIS DE FACTIBILIDAD Y COMPLEJIDAD

**Fecha de anÃ¡lisis**: 2026-01-08

**Resumen**: Se analizan 10 mejoras propuestas para el sistema de Listas de Precios. El anÃ¡lisis incluye factibilidad tÃ©cnica, complejidad, riesgos, dependencias y estimaciÃ³n de esfuerzo.

---

### 1. MÃºltiples acciones por regla

**DescripciÃ³n**: Permitir que una regla tenga varias acciones asociadas (ej: descuento 10% + cargo fijo $50).

**AnÃ¡lisis de Factibilidad**: âœ… **FACTIBLE**

**Complejidad**: MEDIA-ALTA

**Archivos a modificar**:
- `frontend/models/PriceLists.php` - Actualizar validaciÃ³n de `price_rules`
- `frontend/views/price-lists/_form.php` - Modificar UI para permitir mÃºltiples acciones
- `frontend/web/js/pricerules.js` - Refactorizar `savePricerule()`, `editPricerule()`, `getTableHtmlPricerule()` para manejar array de acciones
- `frontend/web/js/pricecalc.js` - Modificar los 3 mÃ©todos de cÃ¡lculo para iterar sobre array de acciones
- `frontend/utils/PriceListCalc.php` - Equivalente en PHP
- `console/migrations/` - MigraciÃ³n para convertir estructura existente

**Estructura de datos propuesta**:
```json
// Antes (actual):
{ "type": "addvalue", "value": 50, "stop": 0, ... }

// DespuÃ©s:
{
  "actions": [
    { "type": "subpercentage", "value": 10 },
    { "type": "addvalue", "value": 50 }
  ],
  "stop": 0,
  ...
}
```

**MigraciÃ³n requerida**:
```php
// Convertir cada regla existente:
// { "type": "X", "value": Y, ... } â†’ { "actions": [{ "type": "X", "value": Y }], ... }
```

**Riesgos**:
- MigraciÃ³n de datos de todas las agencias
- Cambio estructural significativo que afecta JS frontend + PHP backend
- Requiere actualizar impresiÃ³n de listas de precios
- UI necesita rediseÃ±o para mostrar mÃºltiples acciones

**EstimaciÃ³n**: 24-32 horas

---

### 2. Reglas para modificar datos/valores del viaje

**DescripciÃ³n**: Permitir que las reglas activen/desactiven tildes, modifiquen valores numÃ©ricos del viaje, y seleccionen destino frecuente.

**AnÃ¡lisis de Factibilidad**: âš ï¸ **FACTIBLE CON COMPLEJIDAD ALTA**

**Complejidad**: ALTA

**Sub-funcionalidades**:

**2a) Activar/desactivar tildes (checks)**:
- Ya existe parcialmente con `set_var`/`unset_var` para USE_VAT2 y INCLUDE_BASE_DISTANCES
- Extender para cualquier check del viaje
- Archivos: `viajes-all.js`, `processPriceListVariables()`, `PriceListCalc.php`

**2b) Modificar valores numÃ©ricos del viaje**:
- Nueva categorÃ­a de acciones: `set_trip_field`
- Ejemplo: `{ "type": "set_trip_field", "field": "night_charge", "value": 100 }`
- Requiere agregar campos al modelo Viajes si no existen (ej: `night_charge`)
- Archivos: modelos, vistas, funciones de cÃ¡lculo

**2c) Seleccionar destino frecuente**:
- Nueva acciÃ³n: `{ "type": "set_frequent", "value": "Aeroparque - Ezeiza" }`
- Actualizar `#viajes-destino_frecuente` en frontend
- Archivos: `viajes-all.js`, `viajes.js`

**Riesgos**:
- Complejidad del ciclo de recÃ¡lculo (ver ViajesCostService::processPriceListVariables)
- Efectos secundarios al modificar campos del viaje durante el cÃ¡lculo
- Loops infinitos si una regla modifica un valor que afecta las condiciones de otras reglas
- Necesita mecanismo para detectar y evitar recursiÃ³n infinita

**Dependencias**: Depende parcialmente de mejora #1 (mÃºltiples acciones) para implementaciÃ³n limpia.

**EstimaciÃ³n**: 40-56 horas (incluyendo todas las sub-funcionalidades)

---

### 3. Unificar "acciones complementarias" como acciones normales

**DescripciÃ³n**: Convertir `set_var`/`unset_var`/`stop` en acciones type/value normales.

**AnÃ¡lisis de Factibilidad**: âœ… **FACTIBLE**

**Complejidad**: MEDIA

**Dependencias**: Debe implementarse junto con mejora #1.

**Estructura de datos propuesta**:
```json
// Antes:
{ "type": "addvalue", "value": 50, "stop": 1, "set_var": "NOCTURNO" }

// DespuÃ©s:
{
  "actions": [
    { "type": "addvalue", "value": 50 },
    { "type": "set_var", "value": "NOCTURNO" },
    { "type": "stop_rules", "value": 1 }
  ]
}
```

**Archivos a modificar**:
- Los mismos que mejora #1
- MigraciÃ³n adicional para convertir `stop`, `set_var`, `unset_var`

**Riesgos**:
- Rompe compatibilidad hacia atrÃ¡s
- MigraciÃ³n de datos mÃ¡s compleja

**EstimaciÃ³n**: 8-12 horas (adicionales a mejora #1)

---

### 4. PestaÃ±as (tabs) de reglas de precios

**DescripciÃ³n**: Agrupar reglas en pestaÃ±as con nombres personalizados.

**AnÃ¡lisis de Factibilidad**: âœ… **FACTIBLE**

**Complejidad**: ALTA

**Estructura de datos propuesta**:
```json
// Campo price_rules actual:
[{rule1}, {rule2}, ...]

// Campo price_rules nuevo:
{
  "tabs": [
    { "name": "Tarifas base", "rules": [{rule1}, {rule2}] },
    { "name": "Nocturnos", "rules": [{rule3}, {rule4}] },
    { "name": "Zonas especiales", "rules": [{rule5}] }
  ]
}
```

**Archivos a modificar**:
- `frontend/views/price-lists/_form.php` - Agregar UI de pestaÃ±as
- `frontend/web/js/pricerules.js` - Refactorizar completamente para manejar tabs
- `frontend/web/js/pricecalc.js` - Iterar sobre todas las pestaÃ±as en orden
- `frontend/utils/PriceListCalc.php` - Equivalente en PHP
- `frontend/web/css/pricerules.css` - Estilos para pestaÃ±as
- MigraciÃ³n para convertir estructura plana a estructura con tabs

**Notas de UI**:
- Tabs con botÃ³n (+) para agregar nueva pestaÃ±a
- Click derecho o menÃº para renombrar/eliminar pestaÃ±a
- Drag & drop para reordenar pestaÃ±as
- Drag & drop de reglas entre pestaÃ±as

**Riesgos**:
- Cambio estructural muy significativo
- Mayor complejidad de UI
- MigraciÃ³n de datos existentes (lista plana â†’ estructura con una pestaÃ±a "Principal")

**EstimaciÃ³n**: 32-48 horas

---

### 5. Copiar pestaÃ±as entre listas de precios

**DescripciÃ³n**: Copiar pestaÃ±as completas con sus reglas entre diferentes listas de precios.

**AnÃ¡lisis de Factibilidad**: âœ… **FACTIBLE**

**Complejidad**: MEDIA

**Dependencias**: Requiere mejora #4 implementada primero.

**Archivos a modificar**:
- `frontend/views/price-lists/_form.php` - BotÃ³n "Copiar pestaÃ±a desde otra lista" y "Copiar pestaÃ±a a otras listas"
- `frontend/controllers/PriceListsController.php` - Nuevas acciones AJAX:
  - `actionCopyTabFrom($id_source_list, $tab_name)`
  - `actionCopyTabTo($id_dest_lists[], $tab_name, $replace_if_exists)`
- `frontend/web/js/pricelists.js` - Funciones JS para UI de copiado
- Modal para seleccionar lista fuente/destino y pestaÃ±a

**Flujo de usuario**:
1. BotÃ³n "Importar pestaÃ±a" â†’ Modal con dropdown de listas â†’ dropdown de pestaÃ±as â†’ Confirmar
2. Si pestaÃ±a ya existe: "Â¿Reemplazar o cancelar?"
3. BotÃ³n "Exportar pestaÃ±a a otras listas" â†’ Multi-select de listas destino â†’ Confirmar

**Riesgos**:
- Validaciones de permisos (solo listas de la misma agencia)
- Manejo de conflictos de nombres de pestaÃ±as

**EstimaciÃ³n**: 16-24 horas (despuÃ©s de mejora #4)

---

### 6. Calcular precio por zona y precio por kilÃ³metro separados

**DescripciÃ³n**: Calcular dos precios: uno con zonas y otro "puro" por kilÃ³metros, y opcionalmente usar el mayor.

**AnÃ¡lisis de Factibilidad**: âš ï¸ **FACTIBLE CON COMPLEJIDAD SIGNIFICATIVA**

**Complejidad**: ALTA

**AnÃ¡lisis tÃ©cnico**:
La funciÃ³n `calcDistancePrice()` tendrÃ­a que:
1. Ejecutar las reglas normalmente â†’ `priceWithZones`
2. Ejecutar las reglas ignorando condiciones `zone` â†’ `pricePureKm`
3. Si parÃ¡metro activo y `pricePureKm > priceWithZones` â†’ usar `pricePureKm`

**Archivos a modificar**:
- `frontend/web/js/pricecalc.js` - Agregar segundo cÃ¡lculo sin zonas
- `frontend/utils/PriceListCalc.php` - Equivalente PHP
- `frontend/models/PriceLists.php` - Nuevo campo `use_higher_price`
- `frontend/views/price-lists/_form.php` - Checkbox para activar comportamiento
- MigraciÃ³n para nuevo campo en tabla `price_lists`

**LÃ³gica propuesta**:
```javascript
function calcDistancePrice(...) {
  // CÃ¡lculo normal
  let priceWithZones = calculateWithAllRules(pricerules, ...);

  // CÃ¡lculo sin zonas
  let rulesWithoutZones = pricerules.filter(r => !r.zone);
  let pricePureKm = calculateWithAllRules(rulesWithoutZones, ...);

  if (price_list.use_higher_price && pricePureKm > priceWithZones) {
    return { price: pricePureKm, usedPureKm: true, ... };
  }
  return { price: priceWithZones, usedPureKm: false, ... };
}
```

**Riesgos**:
- Duplica el tiempo de cÃ¡lculo
- Complejidad para debug/entender quÃ© precio se usÃ³
- Posible confusiÃ³n de usuarios

**EstimaciÃ³n**: 16-24 horas

---

### 7. Minutos incluidos en viaje (para TBD y similar)

**DescripciÃ³n**: Nueva acciÃ³n de regla que define minutos incluidos en un precio fijo. Tiempo excedente se cobra como espera.

**AnÃ¡lisis de Factibilidad**: âœ… **FACTIBLE**

**Complejidad**: MEDIA

**Archivos a modificar**:
- `frontend/views/price-lists/_form.php` - Nueva opciÃ³n en dropdown de acciones: "Minutos incluidos son"
- `frontend/web/js/pricerules.js` - Agregar opciÃ³n
- `frontend/web/js/pricecalc.js` - Modificar `calcWaitingPrice()` para considerar `included_minutes`
- `frontend/utils/PriceListCalc.php` - Equivalente en PHP

**Estructura de datos**:
```json
{ "type": "includedminutes", "value": 60 }
```

**LÃ³gica de cÃ¡lculo**:
```javascript
// En calcWaitingPrice():
let includedMinutes = 0; // De las reglas de precios

// Durante iteraciÃ³n de reglas:
case 'includedminutes':
  includedMinutes = pricerulevalue;
  break;

// Al calcular:
let tripDuration = ...; // DuraciÃ³n total del viaje en minutos
let waitingTime = ...; // Tiempo de espera registrado
let totalTimeToCharge = Math.max(0, tripDuration - includedMinutes) + waitingTime;
let finalPrice = calcWaitingPriceFromMinutes(totalTimeToCharge, ...);
```

**Riesgos**:
- Requiere que el viaje tenga registrada la duraciÃ³n total (no solo tiempo de espera)
- Verificar que el campo de duraciÃ³n del viaje estÃ© disponible en el cÃ¡lculo

**Datos necesarios**:
- Â¿Existe campo `trip_duration` en el modelo Viajes? Si no, agregar.
- Alternativamente, calcular de `hora_cierre - hora_inicio`

**EstimaciÃ³n**: 12-16 horas

---

### 8. Numerar las reglas de precios

**DescripciÃ³n**: Mostrar nÃºmero secuencial (1, 2, 3...) en cada regla para facilitar referencia.

**AnÃ¡lisis de Factibilidad**: âœ… **FACTIBLE - SIMPLE**

**Complejidad**: BAJA

**Archivos a modificar**:
- `frontend/web/js/pricerules.js` - Modificar `getTableHtmlPricerule()` para agregar nÃºmero

**CÃ³digo actual** (lÃ­nea 286-316 de pricerules.js):
```javascript
htmldata += '<tr id="pr_' + i + '"><td onclick="togglePriceruleRow(' + i + ')">';
```

**CÃ³digo modificado**:
```javascript
htmldata += '<tr id="pr_' + i + '"><td onclick="togglePriceruleRow(' + i + ')">';
htmldata += '<span class="rule-number">' + (i + 1) + '</span> '; // Agregar nÃºmero
```

**CSS** (pricerules.css):
```css
.rule-number {
  color: #888;
  font-weight: bold;
  margin-right: 5px;
}
```

**Riesgos**: Ninguno significativo.

**EstimaciÃ³n**: 2-3 horas

---

### 9. Filtro de bÃºsqueda para reglas de precios

**DescripciÃ³n**: Input de texto para filtrar reglas mostrando solo las que coinciden.

**AnÃ¡lisis de Factibilidad**: âœ… **FACTIBLE**

**Complejidad**: MEDIA

**Archivos a modificar**:
- `frontend/views/price-lists/_form.php` - Agregar input de filtro
- `frontend/web/js/pricerules.js` - FunciÃ³n de filtrado
- `frontend/web/css/pricerules.css` - Estilos para resultados filtrados

**UI propuesta**:
- Input de texto arriba de la tabla de reglas
- Busca en: texto de condiciones + texto de acciones
- Filtrado en tiempo real (keyup)
- Al hacer click en resultado filtrado: expandir pestaÃ±a correcta (si aplica) + scroll + highlight

**CÃ³digo propuesto**:
```javascript
function filterRules(searchText) {
  if (!searchText) {
    // Mostrar todas
    $('#rulestable tr').show();
    return;
  }
  searchText = searchText.toLowerCase();
  $('#rulestable tr').each(function() {
    let ruleText = $(this).text().toLowerCase();
    if (ruleText.indexOf(searchText) >= 0) {
      $(this).show();
    } else {
      $(this).hide();
    }
  });
}

// En input: oninput="filterRules(this.value)"
```

**Si hay pestaÃ±as (mejora #4)**:
- Mostrar en resultados: "[Tab: Nocturnos] #5 Si Hora entre 22 y 06..."
- Al hacer click: `showTab('Nocturnos'); scrollToRule(5);`

**Riesgos**: Bajo, funcionalidad aislada.

**EstimaciÃ³n**: 8-12 horas (6-8h sin pestaÃ±as, +4h con pestaÃ±as)

---

### 10. Duplicar reglas de precios

**DescripciÃ³n**: BotÃ³n para duplicar una regla existente.

**AnÃ¡lisis de Factibilidad**: âœ… **FACTIBLE - SIMPLE**

**Complejidad**: BAJA

**Archivos a modificar**:
- `frontend/views/price-lists/_form.php` - Agregar botÃ³n de duplicar
- `frontend/web/js/pricerules.js` - FunciÃ³n `duplicatePricerule(pos)`

**CÃ³digo propuesto**:
```javascript
// En getTableHtmlPricerule(), agregar botÃ³n junto a editar/eliminar:
htmldata += '<button type="button" class="btn btn-xs btn-gray" onclick="duplicatePricerule(' + i + ')"><span class="glyphicon glyphicon-duplicate"></span></button>';

function duplicatePricerule(pos) {
  // Clonar la regla
  let newRule = JSON.parse(JSON.stringify(pricerules[pos]));
  // Insertar despuÃ©s de la regla actual
  pricerules.splice(pos + 1, 0, newRule);
  // Actualizar hidden field y re-renderizar
  $("#pricelists-price_rules").val(JSON.stringify(pricerules));
  $("#pricesrezisable").html(getTableHtmlPricerule());
  // Marcar la nueva regla
  markPricerule(pos + 1, false);
  blinkInput('pr_' + (pos + 1), 'ruleBlinkClass');
}
```

**Riesgos**: Ninguno significativo.

**EstimaciÃ³n**: 2-3 horas

---

## Resumen de Factibilidad y Estimaciones

| # | Mejora | Factibilidad | Complejidad | Horas Est. | Dependencias |
|---|--------|--------------|-------------|------------|--------------|
| 1 | MÃºltiples acciones por regla | âœ… | Media-Alta | 24-32h | - |
| 2 | Reglas para modificar viaje | âš ï¸ | Alta | 40-56h | Parcial de #1 |
| 3 | Unificar acciones complementarias | âœ… | Media | 8-12h | Requiere #1 |
| 4 | PestaÃ±as de reglas | âœ… | Alta | 32-48h | - |
| 5 | Copiar pestaÃ±as entre listas | âœ… | Media | 16-24h | Requiere #4 |
| 6 | Precio por zona vs kilÃ³metro | âš ï¸ | Alta | 16-24h | - |
| 7 | Minutos incluidos en viaje | âœ… | Media | 12-16h | - |
| 8 | Numerar reglas | âœ… | Baja | 2-3h | - |
| 9 | Filtro de bÃºsqueda | âœ… | Media | 8-12h | Opcional #4 |
| 10 | Duplicar reglas | âœ… | Baja | 2-3h | - |

**Total estimado**: 160-230 horas

---

## Dependencias entre Mejoras

```
#1 (MÃºltiples acciones)
  â””â”€â”€ #3 (Unificar acciones complementarias)
  â””â”€â”€ #2 (Reglas para modificar viaje) - parcial

#4 (PestaÃ±as)
  â””â”€â”€ #5 (Copiar pestaÃ±as)
  â””â”€â”€ #9 (Filtro) - mejora opcional

#8, #10 - Independientes, se pueden hacer en cualquier momento
#6, #7 - Independientes
```

---

## Orden de ImplementaciÃ³n Recomendado

**Fase 1 - Quick wins (4-6h)**:
- #8 Numerar reglas
- #10 Duplicar reglas

**Fase 2 - Mejoras estructurales (56-68h)**:
- #1 MÃºltiples acciones por regla
- #3 Unificar acciones complementarias

**Fase 3 - OrganizaciÃ³n visual (40-60h)**:
- #4 PestaÃ±as de reglas
- #5 Copiar pestaÃ±as entre listas
- #9 Filtro de bÃºsqueda

**Fase 4 - Funcionalidades avanzadas (68-96h)**:
- #2 Reglas para modificar viaje
- #6 Precio por zona vs kilÃ³metro
- #7 Minutos incluidos en viaje

---

## Riesgos Generales

1. **MigraciÃ³n de datos**: Las mejoras #1, #3, #4 requieren migraciones que transforman la estructura de `price_rules`. Se deben implementar con cuidado y probar exhaustivamente.

2. **Paridad JS/PHP**: Todas las mejoras de cÃ¡lculo deben implementarse tanto en `pricecalc.js` como en `PriceListCalc.php`. Cualquier discrepancia causarÃ¡ diferencias entre precios en frontend y backend.

3. **Regresiones**: El sistema de listas de precios es crÃ­tico. Cada cambio debe incluir pruebas de regresiÃ³n con viajes existentes.

4. **Ciclos de recÃ¡lculo**: La mejora #2 puede introducir loops infinitos si una regla modifica valores que afectan las condiciones de otras reglas. Se necesita un mecanismo de detecciÃ³n.

---

## Testing Strategy

Para cada mejora:
1. Unit tests en `frontend/unit/utils/PriceListCalcTest.php`
2. VerificaciÃ³n de paridad JS/PHP con mismos datos de entrada
3. Pruebas de migraciÃ³n en base de datos de staging
4. Pruebas de regresiÃ³n con listas de precios existentes de clientes reales
5. Pruebas de UI en browser

---

---

## ğŸ”µ ANÃLISIS UX: MEJORAS EN LA EDICIÃ“N DE REGLAS DE PRECIOS

**Fecha de anÃ¡lisis**: 2026-01-08

**Objetivo**: Investigar y proponer mejoras de UX/UI para hacer la ediciÃ³n de reglas de precios mÃ¡s intuitiva.

### CÃ³digo Fuente Analizado

**Archivos clave**:
- [frontend/utils/PriceListsService.php](frontend/utils/PriceListsService.php) (806 lÃ­neas) - `enrichPriceRules()`, `getPriceListTypes()`, `getPriceConditionDescriptions()`
- [frontend/web/js/pricerules.js](frontend/web/js/pricerules.js) (1112 lÃ­neas) - `savePricerule()`, `editPricerule()`, `getTableHtmlPricerule()`, `displayCurrentConditions()`

**Estructura JSON de una regla**:
```json
{
  "type": "addpercentage",      // AcciÃ³n (obligatorio)
  "value": "50",                // Valor (obligatorio)
  "stop": 0,                    // Detener reglas (0/1)
  "srvtype": "Auto Sedan",      // CondiciÃ³n: tipo servicio
  "frequent": "Centro-Ezeiza",  // CondiciÃ³n: destino frecuente
  "hourMin": "22", "hourMax": "05",  // CondiciÃ³n: rango horas
  "km": "30", "kmless": "50",   // CondiciÃ³n: km totales >= / <=
  "kmpaxmore": "20", "kmpaxless": "40",  // CondiciÃ³n: km pax >= / <=
  "unittype": "123",            // CondiciÃ³n: tipo unidad (ID)
  "clipax": "cliente-pasajero", // CondiciÃ³n: pasajero especÃ­fico
  "check": "check-return",      // CondiciÃ³n: opcional seleccionado
  "is_var": "VAR_ID",           // CondiciÃ³n: variable prendida
  "isnt_var": "VAR_ID",         // CondiciÃ³n: variable apagada
  "zone": "ZONE_FROM_IS",       // CondiciÃ³n: tipo zona
  "zoneFrom": "123", "zoneTo": "456",  // CondiciÃ³n: zonas (IDs)
  "set_var": "VAR_ID",          // AcciÃ³n complementaria: prender variable
  "unset_var": "VAR_ID"         // AcciÃ³n complementaria: apagar variable
}
```

**Funcionalidades existentes en el cÃ³digo**:

| Funcionalidad | Estado | UbicaciÃ³n en pricerules.js |
|---------------|--------|----------------------------|
| Scroll a regla en tabla | âœ… Existe | `scrollToRowInTable()` lÃ­nea 210 |
| Scroll a viewport | âœ… Existe | `scrollToRowInViewport()` lÃ­nea 222 |
| CSS para regla en ediciÃ³n | âœ… Existe | `.ruleEditingClass` |
| CSS para regla seleccionada | âœ… Existe | `.ruleSelectedClass` |
| SelecciÃ³n mÃºltiple | âœ… Existe | `togglemultiple()` lÃ­nea 1052 |
| Drag & drop para reordenar | âœ… Existe | jQuery UI Sortable |
| Autocomplete srvtype/frequent | âœ… Existe | `setAutocompleteSrvtype()` lÃ­nea 343 |
| NumeraciÃ³n de reglas | âŒ No existe | - |
| BÃºsqueda/filtro | âŒ No existe | - |

### ExploraciÃ³n de la UI

Se explorÃ³ el editor de reglas de precios en `http://localhost/price-lists/update?id=46333` (Lista "GS Remises 2023 Ene" con ~300+ reglas).

**Observaciones del editor actual**:

1. **Vista de lista**:
   - Todas las reglas aparecen en una lista plana sin numeraciÃ³n
   - Cada regla muestra condiciones + acciÃ³n en una sola lÃ­nea
   - Botones: editar (lÃ¡piz), eliminar (papelera), drag-handle (reordenar)
   - Se puede seleccionar una regla haciendo clic (queda con fondo destacado)
   - SelecciÃ³n mÃºltiple disponible con checkbox

2. **Flujo de ediciÃ³n**:
   - Al hacer clic en "editar" (lÃ¡piz), la regla se carga en el formulario superior
   - Las condiciones aparecen como **tags removibles** (ej: "Tipo de Servicio es Auto Sedan Remis âœ•")
   - Un dropdown "Agregar" permite aÃ±adir mÃ¡s condiciones
   - El resultado se selecciona en dropdown + valor en textbox
   - Botones confirmar (âœ“) y cancelar (âœ•)
   - La regla **permanece en su posiciÃ³n original** en la lista durante la ediciÃ³n

3. **Ejemplo observado** (regla con 3 condiciones):
   - Condiciones: "Tipo de Servicio es Auto Sedan Remis", "Destino Frecuente es Centro - Ezeiza Aeropuerto", "Con Espera y Retorno"
   - Resultado: "Agrega %" con valor "50"

---

### Puntos de Dolor Identificados (UX Pain Points)

| # | Problema | Impacto | Severidad |
|---|----------|---------|-----------|
| 1 | **DesconexiÃ³n visual**: El formulario de ediciÃ³n estÃ¡ arriba, pero la regla estÃ¡ en la lista (a veces fuera del viewport) | DifÃ­cil saber quÃ© regla se estÃ¡ editando | ALTA |
| 2 | **Sin numeraciÃ³n**: No hay nÃºmeros de regla para referencia | DifÃ­cil comunicar "la regla 47 tiene un error" | MEDIA |
| 3 | **Lista plana**: 300+ reglas sin agrupaciÃ³n visual | DifÃ­cil encontrar reglas relacionadas | ALTA |
| 4 | **Sin bÃºsqueda**: No hay forma de filtrar/buscar reglas | Encontrar una regla especÃ­fica requiere scroll manual | ALTA |
| 5 | **Una acciÃ³n por regla**: Se necesitan mÃºltiples reglas para condiciones similares | MÃ¡s reglas = mÃ¡s complejidad | MEDIA |
| 6 | **No hay preview**: No se ve cÃ³mo quedarÃ¡ la regla antes de confirmar | Errores se detectan despuÃ©s | BAJA |
| 7 | **Condiciones sin orden**: Las condiciones aparecen como tags sin orden lÃ³gico | Puede confundir el orden de evaluaciÃ³n | BAJA |
| 8 | **Sin tooltips**: Los nombres abreviados no tienen explicaciÃ³n | Usuarios nuevos se confunden | MEDIA |

---

### InvestigaciÃ³n de Patrones UX Modernos

**Patrones estudiados**:
- Adobe Experience Manager Rules Builder
- Zapier Automation Rules
- Gmail Filters
- PatternFly Rule Builder
- SAP Fiori Business Rules

**Conclusiones de la investigaciÃ³n**:

1. **Card-based Rule Editor**: Cada regla es una "tarjeta" expandible con todos sus detalles, en lugar de una fila de tabla.

2. **Inline Editing**: La ediciÃ³n ocurre "en el lugar" donde estÃ¡ la regla, no en un formulario separado.

3. **Collapsible Groups**: Las reglas se agrupan en secciones colapsables (similar a las pestaÃ±as propuestas, pero mÃ¡s visual).

4. **Visual Condition Builder**: Las condiciones se muestran como bloques visuales conectados (AND/OR explÃ­cito).

5. **Drag & Drop**: Reordenamiento intuitivo con feedback visual claro.

6. **Search & Filter**: BÃºsqueda instantÃ¡nea con highlight de coincidencias.

---

### Propuestas de Mejora UX

#### Propuesta A: **Editor de Reglas en Tarjetas (Card-Based)**

**Concepto**: Reemplazar la tabla de filas por tarjetas expandibles.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ #1 ğŸ“¦ [Tipo Servicio: Auto Sedan] [Dest. Frecuente: Centro-Ezeiza]  â”‚
â”‚    â†’ Agrega 50%                                            [â–¼] [â‹®]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ #2 ğŸ“¦ [Hora: 22:00-06:00]                                           â”‚
â”‚    â†’ Agrega 20% (nocturno)                                 [â–¼] [â‹®]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–¼ EXPANDIDO - Modo EdiciÃ³n                                          â”‚
â”‚                                                                     â”‚
â”‚   SI:  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Y  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚        â”‚ Hora entre   â”‚     â”‚ + Agregar    â”‚                        â”‚
â”‚        â”‚ 22:00 - 06:00â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                                     â”‚
â”‚   ENTONCES:  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚              â”‚ Agrega %  â”‚  20  â”‚                                   â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚              [+ Agregar otra acciÃ³n]                                â”‚
â”‚                                                                     â”‚
â”‚   â˜ Detener reglas despuÃ©s de esta                                  â”‚
â”‚                                                [Cancelar] [Guardar] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Beneficios**:
- EdiciÃ³n inline (sin desconexiÃ³n visual)
- Contexto visual claro
- Espacio para mÃºltiples acciones
- Preview integrado

**Complejidad**: ALTA (rediseÃ±o completo de UI)

**EstimaciÃ³n adicional**: 40-60 horas

---

#### Propuesta B: **Mejora Incremental del Editor Actual**

**Concepto**: Mantener la estructura actual pero mejorar puntos crÃ­ticos.

**Cambios propuestos**:

1. **NumeraciÃ³n visible** (ya planificado en #8): 2-3h

2. **BÃºsqueda con highlight** (ya planificado en #9): 8-12h

3. **Mini-preview en formulario**:
   - Mostrar cÃ³mo se verÃ¡ la regla debajo del formulario de ediciÃ³n
   - **EstimaciÃ³n**: 4-6h

4. **Tooltips informativos**:
   - Hover sobre condiciones/acciones muestra descripciÃ³n completa
   - **EstimaciÃ³n**: 4-6h

5. **Indicador de posiciÃ³n**:
   - "Editando regla #47 de 312"
   - **EstimaciÃ³n**: 1-2h

**Beneficios**:
- Menor riesgo (cambios incrementales)
- Compatibilidad con estructura actual
- ImplementaciÃ³n mÃ¡s rÃ¡pida

**EstimaciÃ³n total Propuesta B**: 18-28 horas adicionales

---

#### Propuesta C: **AgrupaciÃ³n Visual por Tipo de Servicio**

**Concepto**: Agrupar automÃ¡ticamente las reglas por el primer tipo de servicio en sus condiciones.

```
â”Œâ”€â”€â”€ Auto Sedan Remis (45 reglas) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [âˆ’] â”€â”€â”
â”‚ #1  [Dest. Frecuente: Centro-Ezeiza] â†’ Agrega 50%          â”‚
â”‚ #2  [Km Totales >= 30] â†’ Precio mÃ­nimo $5000               â”‚
â”‚ #3  ...                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€ Van/Combi (28 reglas) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [âˆ’] â”€â”€â”
â”‚ #46 [Dest. Frecuente: Centro-Ezeiza] â†’ Agrega 60%          â”‚
â”‚ #47 ...                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€ Sin Tipo de Servicio (15 reglas) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [âˆ’] â”€â”€â”
â”‚ #74 [Hora: 22:00-06:00] â†’ Agrega 20%                       â”‚
â”‚ ...                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Beneficios**:
- Vista organizada sin cambiar estructura de datos
- Colapsar/expandir grupos reduce ruido visual
- Compatible con pestaÃ±as (#4) como segunda capa de organizaciÃ³n

**Notas**:
- La agrupaciÃ³n es solo visual, el orden de ejecuciÃ³n sigue siendo lineal
- Requiere indicador claro del orden real de ejecuciÃ³n

**EstimaciÃ³n**: 16-24 horas

---

### RecomendaciÃ³n UX

**ImplementaciÃ³n recomendada en 3 fases**:

**Fase UX-1: Quick Wins (3-5h)**
- #8 Numerar reglas (2-3h)
- Indicador de posiciÃ³n "Editando regla #47 de 312" (1-2h)

**Fase UX-2: Mejoras de Usabilidad (16-24h)**
- #9 Filtro de bÃºsqueda (8-12h)
- Mini-preview en formulario (4-6h)
- Tooltips informativos (4-6h)

**Fase UX-3: OrganizaciÃ³n Visual (32-48h)**
- #4 PestaÃ±as de reglas (implementaciÃ³n actual)
- O alternativamente: AgrupaciÃ³n visual automÃ¡tica (Propuesta C)

**Fase UX-4: RediseÃ±o Mayor (opcional, 40-60h)**
- Propuesta A: Editor en tarjetas (solo si las fases anteriores no son suficientes)

---

### Resumen de Estimaciones UX

| Mejora | Horas | Ya planificada |
|--------|-------|----------------|
| Numerar reglas | 2-3h | âœ… #8 |
| Filtro bÃºsqueda | 8-12h | âœ… #9 |
| Mini-preview | 4-6h | âŒ Nueva |
| Tooltips | 4-6h | âŒ Nueva |
| Indicador posiciÃ³n | 1-2h | âŒ Nueva |
| PestaÃ±as | 32-48h | âœ… #4 |
| AgrupaciÃ³n visual (alt) | 16-24h | âŒ Nueva |
| Editor en tarjetas | 40-60h | âŒ Nueva |

**Total mejoras UX nuevas (sin contar las ya planificadas)**: 25-38 horas
